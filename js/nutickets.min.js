/* globals NUTICKETS_CONFIG:true, jQuery:true */
// NUTICKETS ADMIN PAGE JAVASCRIPT
// Copyright 2016 Nutickets  (email : info@nutickets.com)

// This program is free software; you can redistribute it and/or modify
// it under the terms of the GNU General Public License, version 2, as
// published by the Free Software Foundation.

// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.

// You should have received a copy of the GNU General Public License
// along with this program; if not, write to the Free Software
// Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA

(function($){var utils={};utils.unparam=function(param){var query=window.location.search.substring(1).split("&").reduce(function(obj,tuple){var parts=tuple.split("=");obj[parts[0]]=decodeURIComponent(parts[1]);return obj},{});if(param)return query[param];return query};window.utils=utils;window.region=false;var nutickets_connect_urls=[];nutickets_connect_urls["com"]="https://admin.nutickets.com";nutickets_connect_urls["za"]="https://admin_test.nutickets.co.za";window.nutickets_connect_urls=nutickets_connect_urls;
window.nutickets_login_check_url="/wordpress/login-check";window.nutickets_login_url="/wordpress/";var app={_ready:false,_iframe:null,_queue:false,_callback:null};app.init=function(){window.addEventListener("message",function(e){var data;try{data=window.JSON.parse(e.data)}catch(err){return false}if(!data)return false;if(data.method==="connect")app.message(data)});var iframe=document.createElement("iframe");app._iframe=iframe;iframe.addEventListener("load",function(){app._ready=true;if(app._callback!==
null)app.connect(app._callback)});iframe.frameborder="0";iframe.style.width="1px";iframe.style.border="none";iframe.style.position="absolute";iframe.style.top="-9999em";iframe.style.width="10px";iframe.style.height="10px";iframe.src=nutickets_connect_urls[window.region]+nutickets_login_check_url;document.body.appendChild(iframe)};app.message=function(data){if(app._callback)app._callback.call(window,data)};app.connect=function(callback){app._callback=callback;if(app._ready===false)return false;var msg=
window.JSON.stringify({method:"connect"});app._iframe.contentWindow.postMessage(msg,"*")};var settings={};settings.update=function(key,value){$.post(NUTICKETS_CONFIG.ajaxurl,{"action":"nutickets_update_option","key":key,"value":value},function(response){if(key==="nutickets_width"||key==="nutickets_height")value=response;else if(key==="nutickets_company_id")window.location.reload()});$("#nutickets-settings-saved").show();setTimeout(function(){$("#nutickets-settings-saved").fadeOut()},3E3)};settings.save=
function(company_id,companies){$.post(NUTICKETS_CONFIG.ajaxurl,{"action":"nutickets_save_account","company_id":company_id,"companies":companies,"region":region},function(response){if(response==="true")location.reload();else window.alert(objectL10n.nu_connect_error_text)})};settings.connect=function(callback){app.connect(function(data){if(data.error===false){if(data.companies.length>0){$("#connect-button").text(objectL10n.nu_connect_connect_button_text);settings.save(data.company_id,data.companies)}}else if(callback)callback({error:true});
else window.alert(objectL10n.nu_connect_login_error_warning)})};function getCookie(cname){var name=cname+"=";var ca=document.cookie.split(";");for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==" ")c=c.substring(1);if(c.indexOf(name)==0)return c.substring(name.length,c.length)}return""}function setCookie(cname,cvalue,exdays){var d=new Date;d.setTime(d.getTime()+exdays*24*60*60*1E3);var expires="expires="+d.toUTCString();document.cookie=cname+"="+cvalue+"; "+expires}$(document).ready(function($){var _region=
getCookie("region");if(_region=="com"||_region=="za")region=_region;$('[data-nutickets-input-autosave=""]').focusout(function(){settings.update($(this).attr("name"),$(this).val())});$('[data-nutickets-checkbox-autosave=""]').change(function(){if($(this).is(":not(:checked)"))settings.update($(this).attr("name"),0);else settings.update($(this).attr("name"),$(this).val())});$('select[data-nutickets-input-autosave=""]').change(function(){if($(this).val()!="")settings.update($(this).attr("name"),$(this).val())});
$('[data-nutickets-input-autosave=""]').keypress(function(e){if(e.which===13){settings.update($(this).attr("name"),$(this).val());return false}});$('[data-nutickets-target-toggle=""]').click(function(E){E.preventDefault();var $this=$(this),$target=$($this.attr("href"));$target.each(function(){$(this).toggleClass("nutickets-toggle-active")})});$("#connect-button").click(function(){settings.connect(function(){$("#connect-button").html(objectL10n.nu_connect_redirect_button_text);window.location=[nutickets_connect_urls[region]+
nutickets_login_url+"?back=",encodeURIComponent(window.location.toString())].join("")});return false});$('select[data-change-region=""]').change(function(){if($(this).val()=="za")$(".nutickets-create-account-btn-wrap").hide();else $(".nutickets-create-account-btn-wrap").show();if($(this).val()==""){$("#nutickets-connect-account").hide();$(".nutickets-region-selector").removeClass("compact")}else{region=$(this).val();$("#nutickets-connect-account").show();$(".nutickets-region-selector").addClass("compact");
setCookie("region",region,1);var $btn=$("#connect-button[data-button-text]"),_text=$btn.attr("data-button-text");if(region=="za")_text=_text.replace("%NUTICKETS%","NUTICKETS.CO.ZA");else _text=_text.replace("%NUTICKETS%","NUTICKETS.COM");$("[data-button-text-target]",$btn).text(_text);app.init()}}).trigger("change");if(window.region!==false&&!NUTICKETS_CONFIG.created){$('select[data-change-region=""]').val(region).trigger("change");$("#nutickets-connect-failed-refresh").show();$(".nutickets-create-account-btn-wrap").hide();
settings.connect(function(){})}$('[data-disconnect-nutickets=""]').click(function(E){E.preventDefault();if(confirm(objectL10n.nu_disconnect_warning))$.post(NUTICKETS_CONFIG.ajaxurl,{"action":"nutickets_disconnect_account"},function(response){if(response==="true"){setCookie("region",false,1);location.reload()}else window.alert(objectL10n.nu_disconnect_error_text)})})})})(jQuery);